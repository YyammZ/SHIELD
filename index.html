<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thermosafe Face Recognition</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #0e0e10;
      color: white;
      text-align: center;
      padding: 0;
      margin: 0;
    }
    h1 {
      color: gold;
      text-shadow: 0 0 10px gold;
      font-size: 1.6em;
      margin: 10px 0;
    }
    select {
      margin-top: 10px;
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 2px solid gold;
      background: gold;
      color: #0e0e10;
      font-weight: bold;
      outline: none;
    }

    .camera-container {
      position: relative;
      width: 95vw;
      max-width: 900px;
      margin: 0 auto;
      border: 3px solid gold;
      border-radius: 12px;
      box-shadow: 0 0 25px gold;
      overflow: hidden;
      background-color: black;
    }

    video {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 12px;
      object-fit: cover;
      transform: scaleX(-1);
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    #status {
      margin: 12px 0;
      color: gold;
      font-weight: bold;
    }

    #cameraPermissionPopup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
      text-align: center;
    }
    #cameraPermissionPopup h2 {
      color: gold;
      margin-bottom: 10px;
    }
    #cameraPermissionPopup button {
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      background: gold;
      color: #0e0e10;
      font-weight: bold;
      cursor: pointer;
    }
    #cameraPermissionPopup button:hover {
      background: #ffdf32;
    }
  </style>
</head>
<body>
  <h1>Thermosafe Face Recognition</h1>
  <select id="cameraSelect"></select>

  <div class="camera-container">
    <video id="camera" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="status">üîÑ Menunggu izin kamera...</div>

  <div id="cameraPermissionPopup">
    <h2>üì∑ Izin Akses Kamera</h2>
    <p>Aplikasi ini memerlukan akses ke kamera untuk mendeteksi wajah.</p>
    <button id="allowCameraBtn">Izinkan Kamera</button>
  </div>

  <script>
    const video = document.getElementById('camera');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const cameraSelect = document.getElementById('cameraSelect');
    const statusEl = document.getElementById('status');
    const popup = document.getElementById('cameraPermissionPopup');
    const allowBtn = document.getElementById('allowCameraBtn');

    const SERVER_URL = "https://elease-implacental-shae.ngrok-free.dev/predict";

    let currentStream = null;
    let isPredicting = false;

    async function requestCameraPermission() {
      popup.style.display = 'flex';
      return new Promise(resolve => {
        allowBtn.onclick = async () => {
          popup.style.display = 'none';
          try {
            await navigator.mediaDevices.getUserMedia({ video: true });
            resolve(true);
          } catch (err) {
            statusEl.textContent = "‚ùå Izin kamera ditolak.";
            resolve(false);
          }
        };
      });
    }

    async function getCameras() {
      const granted = await requestCameraPermission();
      if (!granted) return;

      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d => d.kind === 'videoinput');
        cameraSelect.innerHTML = "";
        cams.forEach((c, i) => {
          const opt = document.createElement('option');
          opt.value = c.deviceId;
          opt.text = c.label || `Kamera ${i + 1}`;
          cameraSelect.appendChild(opt);
        });
        if (cams.length > 0) startCamera(cams[0].deviceId);
      } catch (err) {
        statusEl.textContent = "‚ùå Tidak bisa akses kamera: " + err.message;
      }
    }

    async function startCamera(deviceId) {
      if (currentStream) currentStream.getTracks().forEach(t => t.stop());
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: { exact: deviceId } }
        });
        currentStream = stream;
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          resizeCanvas();
          statusEl.textContent = "‚úÖ Kamera aktif ‚Äî memulai prediksi...";
          setTimeout(startPrediction, 1000);
        };
      } catch (err) {
        statusEl.textContent = "‚ùå Gagal buka kamera: " + err.message;
      }
    }

    function resizeCanvas() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    }
    window.addEventListener('resize', resizeCanvas);

    cameraSelect.addEventListener('change', () => startCamera(cameraSelect.value));

    getCameras();

    async function startPrediction() {
      if (isPredicting) return;
      isPredicting = true;

      setInterval(async () => {
        if (video.readyState < 2) return;

        const frame = document.createElement('canvas');
        frame.width = video.videoWidth;
        frame.height = video.videoHeight;
        frame.getContext('2d').drawImage(video, 0, 0, frame.width, frame.height);

        const base64Image = frame.toDataURL("image/jpeg").split(",")[1];

        try {
          const response = await fetch(SERVER_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image: base64Image })
          });

          const result = await response.json();
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          if (result.faces && result.faces.length > 0) {
            statusEl.innerHTML = `üü¢ ${result.faces.length} wajah terdeteksi`;

            result.faces.forEach(face => {
              const [x1, y1, x2, y2] = face.box;
              const name = face.name;
              const conf = Math.round(face.confidence * 100);

              ctx.strokeStyle = conf >= 80 ? "lime" : "orange";
              ctx.lineWidth = 2;
              ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

              if (conf >= 80) {
                ctx.fillStyle = "lime";
                ctx.font = `${Math.max(14, canvas.width / 40)}px Arial`;
                ctx.fillText(`${name} (${conf}%)`, x1 + 5, y1 - 10);
              } else {
                ctx.fillStyle = "orange";
                ctx.font = `${Math.max(14, canvas.width / 40)}px Arial`;
                ctx.fillText(`Unknown ${conf}%`, x1 + 5, y1 - 10);
              }
            });
          } else {
            statusEl.textContent = "üü° Tidak ada wajah terdeteksi";
          }
        } catch (err) {
          statusEl.textContent = "‚ö†Ô∏è Gagal prediksi: " + err.message;
        }
      }, 600);
    }
  </script>
</body>
</html>

